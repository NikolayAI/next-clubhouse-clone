function e(e,t){for(let r in e)t(e[r],r)}function t(e,t){e.forEach(t)}function r(e,t){if(!e)throw Error(t)}function n(e,t){Ne={parent:Ne,value:e,template:Ie(e,'template')||Fe(),sidRoot:Ie(e,'sidRoot')||Ne&&Ne.sidRoot};try{return t()}finally{Ne=je(Ne)}}function a({node:e=[],from:r,source:n,parent:a=r||n,to:o,target:l,child:s=o||l,scope:i={},meta:f={},family:c={type:'regular'},regional:u}={}){let d=Re(a),p=Re(c.links),m=Re(c.owners),g=[];t(e,(e=>e&&G(g,e)));let h={id:ae(),seq:g,next:Re(s),meta:f,scope:i,family:{type:c.type||"crosslink",links:p,owners:m}};return t(p,(e=>G(we(e),h))),t(m,(e=>G(Se(e),h))),t(d,(e=>G(e.next,h))),u&&Ne&&$e(Ce(Ne),[h]),h}function o(e,r,n){let a=Je,o=null,l=Ue;if(e.target&&(r=e.params,n=e.defer,a='page'in e?e.page:a,e.stack&&(o=e.stack),l=Ae(e)||l,e=e.target),l&&Ue&&l!==Ue&&(Ue=null),Array.isArray(e))for(let t=0;t<e.length;t++)Le('pure',a,ke(e[t]),o,r[t],l);else Le('pure',a,ke(e),o,r,l);if(n&&!He)return;let s,i,f,c,u,d,p={isRoot:He,currentPage:Je,scope:Ue,isWatch:Ge};He=0;e:for(;c=Ee();){let{idx:e,stack:r,type:n}=c;f=r.node,Je=u=r.page,Ue=Ae(r),u?d=u.reg:Ue&&(d=Ue.reg);let a=!!u,o=!!Ue,l={fail:0,scope:f.scope};s=i=0;for(let t=e;t<f.seq.length&&!s;t++){let c=f.seq[t];if(c.order){let{priority:a,barrierID:o}=c.order,l=o?u?`${u.fullID}_${o}`:o:0;if(t!==e||n!==a){o?We.has(l)||(We.add(l),Be(t,r,a,o)):Be(t,r,a);continue e}o&&We.delete(l)}switch(c.type){case'mov':{let e,t=c.data;switch(t.from){case z:e=Ce(r);break;case"a":case'b':e=r[t.from];break;case"value":e=t.store;break;case"store":if(d&&!d[t.store.id])if(a){let e=Xe(u,t.store.id);r.page=u=e,e?d=e.reg:o?(Ze(Ue,t.store,0,1,t.softRead),d=Ue.reg):d=void 0}else o&&Ze(Ue,t.store,0,1,t.softRead);e=ge(d&&d[t.store.id]||t.store)}switch(t.to){case z:r.value=e;break;case"a":case'b':r[t.to]=e;break;case"store":Ye(u,Ue,f,t.target).current=e}break}case'compute':let e=c.data;if(e.fn){Ge='watch'===Ie(f,'op');let t=e.safe?(0,e.fn)(Ce(r),l.scope,r):et(l,e.fn,r);e.filter?i=!t:r.value=t,Ge=p.isWatch}}s=l.fail||i}if(!s){let e=Ce(r);t(f.next,(t=>{Le('child',u,t,r,e,Ae(r))}));let n=Ae(r);if(n){Ie(f,'needFxCounter')&&Le('child',u,n.fxCount,r,e,n),Ie(f,'storeChange')&&Le('child',u,n.storeChange,r,e,n);let a=n.additionalLinks[f.id];a&&t(a,(t=>{Le('child',u,t,r,e,n)}))}}}He=p.isRoot,Je=p.currentPage,Ue=Ae(p)}function l(t,r="combine"){let n=r+'(',a='',o=0;return e(t,(e=>{o<25&&(null!=e&&(n+=a,n+=_(e)?tt(e).fullName:e.toString()),o+=1,a=', ')})),n+')'}function s(e,t){e.shortName=t,Object.assign(tt(e),i(t,je(e)))}function i(e,t){let r,n,a=e;if(t){let a=tt(t);0===e.length?(r=a.path,n=a.fullName):(r=a.path.concat([e]),n=0===a.fullName.length?e:a.fullName+'/'+e)}else r=0===e.length?[]:[e],n=e;return{shortName:a,fullName:n,path:r}}function f(e,t){let r=t?e:e[0];return Y(r),r.and&&(e=r.and),[e,r.or]}function c(e,...t){let r=Fe();if(r){let n=r.handlers[e];if(n)return n(r,...t)}}function u(e,t){let r=(e,...t)=>(J(!Ie(r,'derived'),'call of derived event','createEvent'),Je?((e,t,r,n)=>{let a=Je,o=null;if(t)for(o=Je;o&&o.template!==t;)o=je(o);Qe(o);let l=e.create(r,n);return Qe(a),l})(r,n,e,t):r.create(e,t)),n=Fe();return Object.assign(r,{graphite:a({meta:pt("event",r,e,t),regional:1}),create:e=>(o({target:r,params:e,scope:Ue}),e),watch:e=>ut(r,e),map:e=>gt(r,R,e,[ie({fn:ve})]),filter:e=>gt(r,"filter",e.fn?e:e.fn,[fe({fn:ve})]),filterMap:e=>gt(r,'filterMap',e,[ie({fn:ve}),ue((e=>!X(e)),1)]),prepend(e){let t=u('* \u2192 '+r.shortName,{parent:je(r)});return c('eventPrepend',ke(t)),ft(t,r,[ie({fn:ve})],'prepend',e),dt(r,t),t}})}function d(e,n){let l=me(e),s=mt('updates');c('storeBase',l);let i=l.id,f={subscribers:new Map,updates:s,defaultState:e,stateRef:l,getState(){let e,t=l;if(Je){let t=Je;for(;t&&!t.reg[i];)t=je(t);t&&(e=t)}return!e&&Ue&&(Ze(Ue,l,1),e=Ue),e&&(t=e.reg[i]),ge(t)},setState:e=>o({target:f,params:e,defer:1,scope:Ue}),reset:(...e)=>(t(e,(e=>f.on(e,(()=>f.defaultState)))),f),on:(e,r)=>(ee(e,'.on','first argument'),J(!Ie(f,'derived'),'.on in derived store','createStore'),t(Array.isArray(e)?e:[e],(e=>{f.off(e),Me(f).set(e,st(ht(e,f,'on',be,r)))})),f),off(e){let t=Me(f).get(e);return t&&(t(),Me(f).delete(e)),f},map(e,t){let r,n;K(e)&&(r=e,e=e.fn),J(X(t),'second argument of store.map','updateFilter');let a=f.getState();Fe()?n=null:X(a)||(n=e(a,t));let o=d(n,{name:`${f.shortName} \u2192 *`,derived:1,and:r}),s=ht(f,o,R,ye,e);return he(xe(o),{type:R,fn:e,from:l}),xe(o).noInit=1,c('storeMap',l,s),o},watch(e,t){if(!t||!_(e)){let t=ut(f,e);return c('storeWatch',l,e)||e(f.getState()),t}return r(Q(t),'second argument should be a function'),e.watch((e=>t(f.getState(),e)))}},u=pt("store",f,n),p=f.defaultConfig.updateFilter;f.graphite=a({scope:{state:l,fn:p},node:[ue(((e,t,r)=>(r.scope&&!r.scope.reg[l.id]&&(r.b=1),e))),de(l),ue(((e,t,{a:r,b:n})=>!X(e)&&(e!==r||n)),1),p&&fe({fn:ye}),se({from:z,target:l})],child:s,meta:u,regional:1});let m=Ie(f,'sid');return m&&('ignore'!==Ie(f,'serialize')&&qe(f,'storeChange',1),l.sid=m),r(Ie(f,'derived')||!X(e),"current state can't be undefined, use null instead"),$e(f,[s]),f}function p(...e){let t,n,a;[e,a]=f(e);let o,l,s,i=e[e.length-1];if(Q(i)?(n=e.slice(0,-1),t=i):n=e,1===n.length){let e=n[0];V(e)||(o=e,l=1)}if(!l&&(o=n,t)){s=1;let e=t;t=t=>e(...t)}return r(K(o),'shape should be an object'),yt(Array.isArray(o),!s,o,a,t)}function m(...e){return J(0,'createStoreObject','combine'),p(...e)}function g(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function h(e,t){let n=u(Q(e)?{handler:e}:e,t),l=ke(n);qe(l,'op',n.kind="effect"),n.use=e=>(r(Q(e),'.use argument should be a function'),m.scope.handler=e,n),n.use.getCurrent=()=>m.scope.handler;let s=n.finally=mt('finally'),i=n.done=s.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=n.fail=s.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),c=n.doneData=i.map({named:'doneData',fn:({result:e})=>e}),p=n.failData=f.map({named:'failData',fn:({error:e})=>e}),m=a({scope:{handlerId:Ie(l,'sid'),handler:n.defaultConfig.handler||(()=>r(0,`no handler used in ${n.getType()}`))},node:[ue(((e,t,r)=>{let n=t,a=n.handler;if(Ae(r)){let e=Ae(r).handlers[n.handlerId];e&&(a=e)}return e.handler=a,e}),0,1),ue((({params:e,req:t,handler:r,args:n=[e]},a,o)=>{let l=vt(e,t,1,s,o),i=vt(e,t,0,s,o),[f,c]=bt(r,i,n);f&&(K(c)&&Q(c.then)?c.then(l,i):l(c))}),0,1)],meta:{op:'fx',fx:'runner'}});l.scope.runner=m,G(l.seq,ue(((e,{runner:t},r)=>{let n=je(r)?{params:e,req:{rs(e){},rj(e){}}}:e;return o({target:t,params:n,defer:1,scope:Ae(r)}),n.params}),0,1)),n.create=e=>{let t=g(),r={params:e,req:t};if(Ue){if(!Ge){let e=Ue;t.req.finally((()=>{Ke(e)})).catch((()=>{}))}o({target:n,params:r,scope:Ue})}else o(n,r);return t.req};let h=n.inFlight=d(0,{named:'inFlight'}).on(n,(e=>e+1)).on(s,(e=>e-1));qe(s,'needFxCounter','dec'),qe(n,'needFxCounter',1);let y=n.pending=h.map({fn:e=>e>0,named:'pending'});return $e(n,[s,i,f,c,p,y,h]),n}function y(e){let t;[e,t]=f(e,1);let{source:r,effect:n,mapParams:a}=e,l=h(e,t);qe(l,'attached',1);let s,{runner:i}=ke(l).scope,c=ue(((e,t,n)=>{let s,{params:i,req:f,handler:c}=e,u=l.finally,d=vt(i,f,0,u,n),p=n.a,m=L(c),g=1;if(a?[g,s]=bt(a,d,[i,p]):s=r&&m?p:i,g){if(!m)return e.args=[p,s],1;o({target:c,params:{params:s,req:{rs:vt(i,f,1,u,n),rj:d}},page:n.page,defer:1})}}),1,1);if(r){let e;V(r)?(e=r,$e(e,[l])):(e=p(r),$e(l,[e])),s=[de(xe(e)),c]}else s=[c];return i.seq.splice(1,0,...s),l.use(n),dt(n,l,"effect"),l}function b(...t){let[[r,n],a]=f(t),o={};return e(n,((e,t)=>{let n=o[t]=u(t,{parent:je(r),config:a});r.on(n,e),dt(r,n)})),o}function v(r,n){let l=a({family:{type:"domain"},regional:1}),s={history:{},graphite:l,hooks:{}};l.meta=pt("domain",s,r,n),e({Event:u,Effect:h,Store:d,Domain:v},((e,r)=>{let n=r.toLowerCase(),a=mt(`on${r}`);s.hooks[n]=a;let l=new Set;s.history[`${n}s`]=l,a.create=e=>(o(a,e),e),G(ke(a).seq,ue(((e,t,r)=>(r.scope=null,e)))),a.watch((e=>{$e(s,[e]),l.add(e),e.ownerSet||(e.ownerSet=l),je(e)||(e.parent=s)})),$e(s,[a]),s[`onCreate${r}`]=e=>(t(l,e),a.watch(e)),s[`create${r}`]=s[n]=(t,r)=>a(e(t,{parent:s,or:r}))}));let i=je(s);return i&&e(s.hooks,((e,t)=>ft(e,i.hooks[t]))),s}function k(e){Y(e);let t=D in e?e[D]():e;r(t.subscribe,'expect observable to have .subscribe');let n=u(),a=st(n);return t.subscribe({next:n,error:a,complete:a}),n}function w(e,t){let r=u(t||l(e,'merge'));return ee(e,'merge','first argument'),ft(e,r,[],'merge'),r}function S(e,n){let a=0;return t(wt,(t=>{t in e&&(r(null!=e[t],St(n,t)),a=1)})),a}function x(...e){let t,r,n,[[o,l,s],i]=f(e),p=1;X(l)&&K(o)&&S(o,'sample')&&(l=o.clock,s=o.fn,p=!o.greedy,t=o.target,r=o.name,n=o.sid,o=o.source),[o,l]=xt(o,l,'sample'),X(l)&&(l=o),ee(l,'sample','clock'),i||r||(r=o.shortName);let m=!!t;if(t||(V(o)&&V(l)?t=d(s?s(ge(xe(o)),ge(xe(l))):ge(xe(o)),{name:r,sid:n,or:i}):(t=u(r,i),c('sampleTarget',ke(t)))),V(o)){let e=xe(o);$e(o,[ft(l,t,[c('sampleSourceLoader'),de(e,!s,p),s&&ie({fn:be}),c('sampleSourceUpward',m)],"sample",s)]),c('sampleStoreSource',e)}else{let e=me(0),r=me(),n=me();c('sampleNonStoreSource',e,r,n),a({parent:o,node:[se({from:z,target:r}),se({from:"value",store:1,target:e})],family:{owners:[o,t,l],links:t},meta:{op:"sample"},regional:1}),$e(o,[ft(l,t,[c('sampleSourceLoader'),se({from:z,target:n}),de(e,1),ue((e=>e),1),de(r,1,p),de(n),s&&ie({fn:ye}),c('sampleSourceUpward',m)],"sample",s)])}return t}function C(...e){let t='guard',[[n,o],l]=f(e);o||(o=n,n=o.source),S(o,t);let{filter:s,greedy:i,clock:c,name:d=(l&&l.name?l.name:t)}=o,p=o.target||u(d,l),m=_(s);return[n,c]=xt(n,c,t),c&&(ee(c,t,'clock'),n=x({source:n,clock:c,greedy:i,fn:m?null:(e,t)=>({source:e,clock:t})})),ee(p,t,'target'),m?x({source:s,clock:n,target:a({node:[ue((({guard:e})=>e),1),ue((({data:e})=>e))],child:p,meta:{op:t},family:{owners:[n,s,p,...[].concat(c||[])],links:p},regional:1}),fn:(e,t)=>({guard:e,data:t}),greedy:i,name:d}):(r(Q(s),'`filter` should be function or unit'),ft(n,p,c?[fe({fn:({source:e,clock:t},{fn:r})=>r(e,t)}),ue((({source:e})=>e))]:[fe({fn:ve})],t,s)),p}function M(t,r,n){if(V(t))return t;if(E(t)||L(t)){let e=je(t),a=d(r,{parent:e,name:t.shortName,and:n});return ft(L(t)?t.doneData:t,a),e&&e.hooks.store(a),a}let a=Array.isArray(t)?[]:{};return e(t,((e,t)=>a[t]=V(e)?e:d(e,{name:t}))),a}function j(...t){let n,[[o,l],s]=f(t),i=!l;i&&(n=o.cases,l=o.match,o=o.source);let d=V(l),p=!_(l)&&Q(l),m=!d&&!p&&K(l);n||(n={}),i||(r(m,'match should be an object'),e(l,((e,t)=>n[t]=u(s))),n.__=u(s));let g,h=new Set([].concat(o,Object.values(n))),y=Object.keys(d||p?n:l);if(d||p)d&&h.add(l),g=[d&&de(xe(l),0,1),ie({safe:d,filter:1,fn(e,t,r){let n=String(d?r.a:l(e));Ct(t,U(y,n)?n:'__',e,r)}})];else if(m){let t=me({});t.type='shape';let r,n=[];e(l,((e,a)=>{if(_(e)){r=1,G(n,a),h.add(e);let o=ft(e,[],[de(t),ue(((e,t,{a:r})=>r[a]=e))]);if(V(e)){t.current[a]=e.getState();let r=xe(e);he(t,{from:r,field:a,type:'field'}),c('splitMatchStore',r,o)}}})),r&&c('splitBase',t),g=[r&&de(t,0,1),fe({fn(e,t,r){for(let a=0;a<y.length;a++){let o=y[a];if(U(n,o)?r.a[o]:l[o](e))return void Ct(t,o,e,r)}Ct(t,'__',e,r)}})]}else r(0,'expect match to be unit, function or object');if(a({meta:{op:'split'},parent:o,scope:n,node:g,family:{owners:Array.from(h)},regional:1}),!i)return n}function A(e,{scope:t,params:r}){if(!_(e))return Promise.reject(Error('first argument should be unit'));let n=g();n.parentFork=Ue;let{fxCount:a}=t;G(a.scope.defers,n);let l=[e],s=[];return G(s,L(e)?{params:r,req:{rs(e){n.value={status:'done',value:e}},rj(e){n.value={status:'fail',value:e}}}}:r),G(l,a),G(s,null),o({target:l,params:s,scope:t}),n.req}function I(e,r){let n=[];(function e(a){U(n,a)||(G(n,a),"store"===Ie(a,'op')&&Ie(a,'sid')&&r(a,Ie(a,'sid')),t(a.next,e),t(we(a),e),t(Se(a),e))})(e)}function q(e,n){if(Array.isArray(e)&&(e=new Map(e)),e instanceof Map){let a={};return t(e,((e,t)=>{r(_(t),'Map key should be a unit'),n&&n(t,e),r(t.sid,'unit should have a sid'),r(!(t.sid in a),'duplicate sid found'),a[t.sid]=e})),a}return e}function $(e,n){let o,l=e;B(e)&&(o=e,l=n);let s=(e=>{let r=a({scope:{defers:[],inFlight:0,fxID:0},node:[ue(((e,t,r)=>{je(r)?'dec'===Ie(je(r).node,'needFxCounter')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1})),ie({priority:"sampler",batch:1}),ue(((e,r)=>{let{defers:n,fxID:a}=r;r.inFlight>0||0===n.length||Promise.resolve().then((()=>{r.fxID===a&&t(n.splice(0,n.length),(e=>{Ke(e.parentFork),e.rs(e.value)}))}))}),0,1)]}),n=a({node:[ue(((e,t,r)=>{let n=je(r);if(n&&je(n)){let t=n.node;if(!Ie(t,'isCombine')||'combine'!==Ie(je(n).node,'op')){let n=Ae(r),a=t.scope.state.id,o=Ie(t,'sid');n.sidIdMap[o]=a,n.sidValuesMap[o]=e}}}))]}),o={cloneOf:e,reg:{},sidValuesMap:{},sidIdMap:{},getState(e){if('current'in e)return Ye(Je,o,null,e).current;let t=ke(e);return Ye(Je,o,t,t.scope.state,1).current},kind:"scope",graphite:a({family:{type:"domain",links:[r,n]},meta:{unit:'fork'},scope:{forkInFlightCounter:r}}),additionalLinks:{},handlers:{},fxCount:r,storeChange:n};return o})(o);if(l){if(l.values){let e=q(l.values,(e=>r(V(e),'Values map can contain only stores as keys')));Object.assign(s.sidValuesMap,e)}l.handlers&&(s.handlers=q(l.handlers,(e=>r(L(e),"Handlers map can contain only effects as keys"))))}return s}function N(e,{values:t}){r(K(t),'values property should be an object');let n,a,l,s=q(t),i=Object.getOwnPropertyNames(s),f=[],c=[];T(e)?(n=e,l=1,r(n.cloneOf,'scope should be created from domain'),a=ke(n.cloneOf)):B(e)?a=ke(e):r(0,'first argument of hydrate should be domain or scope'),I(a,((e,t)=>{U(i,t)&&(G(f,e),G(c,s[t]))})),o({target:f,params:c,scope:n}),l&&Object.assign(n.sidValuesMap,s)}function F(e,{scope:t}={}){r(t||Ue,'scopeBind cannot be called outside of forked .watch');let n=t||Ue;return L(e)?t=>{let r=g();return o({target:e,params:{params:t,req:r},scope:n}),r.req}:t=>(o({target:e,params:t,scope:n}),t)}function O(t,n={}){let a=n.ignore?n.ignore.map((({sid:e})=>e)):[],o={};return e(t.sidValuesMap,((e,r)=>{if(U(a,r))return;let n=t.sidIdMap[r];o[r]=n&&n in t.reg?t.reg[n].current:e})),'onlyChanges'in n&&!n.onlyChanges&&(r(t.cloneOf,'scope should be created from domain'),I(ke(t.cloneOf),((e,r)=>{r in o||U(a,r)||Ie(e,'isCombine')||'ignore'===Ie(e,'serialize')||(o[r]=t.getState(e))}))),o}let D='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',R='map',z='stack',_=e=>(Q(e)||K(e))&&'kind'in e;const P=e=>t=>_(t)&&t.kind===e;let V=P("store"),E=P("event"),L=P("effect"),B=P("domain"),T=P("scope");var W={__proto__:null,unit:_,store:V,event:E,effect:L,domain:B,scope:T};let U=(e,t)=>e.includes(t),H=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},G=(e,t)=>e.push(t),J=(e,t,r)=>!e&&console.error(`${t} is deprecated, use ${r} instead`),K=e=>'object'==typeof e&&null!==e,Q=e=>'function'==typeof e,X=e=>void 0===e,Y=e=>r(K(e)||Q(e),'expect first argument be an object');const Z=(e,t,n,a)=>r(!(!K(e)&&!Q(e)||!('family'in e)&&!('graphite'in e)),`${t}: expect ${n} to be a unit (store, event or effect)${a}`);let ee=(e,r,n)=>{Array.isArray(e)?t(e,((e,t)=>Z(e,r,`${t} item of ${n}`,''))):Z(e,r,n,' or array of units')};const te=()=>{let e=0;return()=>""+ ++e};let re=te(),ne=te(),ae=te();const oe=(e,t,r,n)=>{let a={id:ne(),type:e,data:t};return r&&(a.order={priority:r},n&&(a.order.barrierID=++le)),a};let le=0,se=({from:e="store",store:t,target:r,to:n=(r?"store":z),batch:a,priority:o})=>oe('mov',{from:e,store:t,to:n,target:r},o,a),ie=({fn:e,batch:t,priority:r,safe:n=0,filter:a=0})=>oe('compute',{fn:e,safe:n,filter:a},r,t),fe=({fn:e})=>ie({fn:e,filter:1}),ce=({fn:e})=>ie({fn:e,priority:"effect"}),ue=(e,t,r)=>ie({fn:e,safe:1,filter:t,priority:r&&"effect"}),de=(e,t,r)=>se({store:e,to:t?z:"a",priority:r&&"sampler",batch:1}),pe={mov:se,compute:ie,filter:fe,run:ce},me=e=>({id:ne(),current:e}),ge=({current:e})=>e,he=(e,t)=>{e.before||(e.before=[]),G(e.before,t)},ye=(e,{fn:t},{a:r})=>t(e,r),be=(e,{fn:t},{a:r})=>t(r,e),ve=(e,{fn:t})=>t(e),ke=e=>e.graphite||e,we=e=>e.family.owners,Se=e=>e.family.links,xe=e=>e.stateRef,Ce=e=>e.value,Me=e=>e.subscribers,je=e=>e.parent,Ae=e=>e.scope,Ie=(e,t)=>ke(e).meta[t],qe=(e,t,r)=>ke(e).meta[t]=r,$e=(e,r)=>{let n=ke(e);t(r,(e=>{let t=ke(e);"domain"!==n.family.type&&(t.family.type="crosslink"),G(we(t),n),G(Se(n),t)}))},Ne=null,Fe=()=>Ne&&Ne.template,Oe=e=>(e&&Ne&&Ne.sidRoot&&(e=`${Ne.sidRoot}|${e}`),e),De=({sid:e,name:t,loc:r,method:o,fn:l})=>n(a({meta:{sidRoot:Oe(e),name:t,loc:r,method:o}}),l);const Re=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(ke);let ze=null;const _e=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||Te(e.v.type)>Te(t.v.type))&&(r=e,e=t,t=r),r=_e(e.r,t),e.r=e.l,e.l=r,e},Pe=[];let Ve=0;for(;Ve<6;)G(Pe,{first:null,last:null,size:0}),Ve+=1;const Ee=()=>{for(let e=0;e<6;e++){let t=Pe[e];if(t.size>0){if(3===e||4===e){t.size-=1;let e=ze.v;return ze=_e(ze.l,ze.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Le=(e,t,r,n,a,o)=>Be(0,{a:null,b:null,node:r,parent:n,value:a,page:t,scope:o},e),Be=(e,t,r,n=0)=>{let a=Te(r),o=Pe[a],l={v:{idx:e,stack:t,type:r,id:n},l:null,r:null};3===a||4===a?ze=_e(ze,l):(0===o.size?o.first=l:o.last.r=l,o.last=l),o.size+=1},Te=e=>{switch(e){case'child':return 0;case'pure':return 1;case'read':return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},We=new Set;let Ue,He=1,Ge=0,Je=null,Ke=e=>{Ue=e},Qe=e=>{Je=e};const Xe=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=je(e);if(e)return e}return null};let Ye=(e,t,r,n,a)=>{let o=Xe(e,n.id);return o?o.reg[n.id]:t?(Ze(t,n,a),t.reg[n.id]):n},Ze=(e,r,n,a,o)=>{let l=e.reg,s=r.sid;if(l[r.id])return;let i={id:r.id,current:r.current};if(s&&s in e.sidValuesMap&&!(s in e.sidIdMap))i.current=e.sidValuesMap[s];else if(r.before&&!o){let o=0,s=n||!r.noInit||a;t(r.before,(t=>{switch(t.type){case R:{let r=t.from;if(r||t.fn){r&&Ze(e,r,n,a);let o=r&&l[r.id].current;s&&(i.current=t.fn?t.fn(o):o)}break}case'field':o||(o=1,i.current=Array.isArray(i.current)?[...i.current]:{...i.current}),Ze(e,t.from,n,a),s&&(i.current[t.field]=l[l[t.from.id].id].current)}}))}s&&(e.sidIdMap[s]=r.id),l[r.id]=i};const et=(e,t,r)=>{try{return t(Ce(r),e.scope,r)}catch(t){console.error(t),e.fail=1}},tt=e=>e.compositeName;let rt=(t,r={})=>(K(t)&&(rt(t.or,r),e(t,((e,t)=>{X(e)||'or'===t||'and'===t||(r[t]=e)})),rt(t.and,r)),r);const nt=(e,t)=>{H(e.next,t),H(we(e),t),H(Se(e),t)},at=(e,t,r)=>{let n;e.next.length=0,e.seq.length=0,e.scope=null;let a=Se(e);for(;n=a.pop();)nt(n,e),(t||r&&'sample'!==Ie(e,'op')||"crosslink"===n.family.type)&&at(n,t,'on'!==Ie(n,'op')&&r);for(a=we(e);n=a.pop();)nt(n,e),r&&"crosslink"===n.family.type&&at(n,t,'on'!==Ie(n,'op')&&r)},ot=e=>e.clear();let lt=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),V(e))ot(Me(e));else if(B(e)){r=1;let t=e.history;ot(t.events),ot(t.effects),ot(t.stores),ot(t.domains)}at(ke(e),!!t,r)},st=e=>{let t=()=>lt(e);return t.unsubscribe=t,t},ft=(e,t,r,n,o)=>a({node:r,parent:e,child:t,scope:{fn:o},meta:{op:n},family:{owners:[e,t],links:t},regional:1}),ct=e=>{let[{from:t,to:r},n]=f(e,1);return ee(t,'forward','"from"'),ee(r,'forward','"to"'),st(a({parent:t,child:r,meta:{op:'forward',config:n},family:{},regional:1}))},ut=(e,t)=>(r(Q(t),'.watch argument should be a function'),st(a({scope:{fn:t},node:[ce({fn:ve})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))),dt=(e,t,r="event")=>{je(e)&&je(e).hooks[r](t)},pt=(e,t,r,n)=>{let a="domain"===e,o=re(),l=rt({or:n,and:'string'==typeof r?{name:r}:r}),{parent:s=null,sid:f=null,named:c=null}=l,u=c||l.name||(a?'':o),d=i(u,s),p={op:t.kind=e,name:t.shortName=u,sid:t.sid=Oe(f),named:c,unitId:t.id=o,serialize:l.serialize,derived:l.derived};if(t.parent=s,t.compositeName=d,t.defaultConfig=l,t.thru=e=>(J(0,'thru','js pipe'),e(t)),t.getType=()=>d.fullName,!a){t.subscribe=e=>(Y(e),t.watch(Q(e)?e:t=>e.next&&e.next(t))),t[D]=()=>t;let e=Fe();e&&(p.nativeTemplate=e)}return p},mt=e=>u({named:e});const gt=(e,t,r,n)=>{let a;K(r)&&(a=r,r=r.fn);let o=u({name:`${e.shortName} \u2192 *`,derived:1,and:a});return ft(e,o,n,t,r),o},ht=(e,t,r,n,a)=>{let o=xe(t),l=se({store:o,to:"a",priority:'read'});r===R&&(l.data.softRead=1);let s=[l,ie({fn:n})];return c('storeOnMap',o,s,V(e)&&xe(e)),ft(e,t,s,r,a)},yt=(t,n,a,o,s)=>{let i=t?e=>e.slice():e=>({...e}),f=t?[]:{},u=i(f),p=me(u),m=me(1);p.type=t?'list':'shape',p.noInit=1,c('combineBase',p,m);let g=d(u,{name:l(a),derived:1,and:o}),h=xe(g);h.noInit=1,qe(g,'isCombine',1);let y=[ue(((e,t,r)=>(r.scope&&!r.scope.reg[p.id]&&(r.c=1),e))),de(p),se({store:m,to:'b'}),ue(((e,{key:t},r)=>{if(r.c||e!==r.a[t])return n&&r.b&&(r.a=i(r.a)),r.a[t]=e,1}),1),se({from:"a",target:p}),se({from:"value",store:0,target:m}),se({from:"value",store:1,target:m,priority:"barrier",batch:1}),de(p,1),s&&ie({fn:ve})];return e(a,((e,t)=>{if(!V(e))return r(!_(e)&&!X(e),`combine expects a store in a field ${t}`),void(u[t]=f[t]=e);f[t]=e.defaultState,u[t]=e.getState();let n=ft(e,g,y,'combine',s);n.scope.key=t;let a=xe(e);he(p,{type:'field',field:t,from:a}),c('combineField',a,n)})),g.defaultShape=a,he(h,{type:R,from:p,fn:s}),Fe()||(g.defaultState=s?h.current=s(u):f),g};let bt=(e,t,r)=>{try{return[1,e(...r)]}catch(e){return t(e),[0,null]}},vt=(e,t,r,n,a)=>l=>o({target:[n,kt],params:[r?{status:'done',params:e,result:l}:{status:'fail',params:e,error:l},{value:l,fn:r?t.rs:t.rj}],defer:1,page:a.page,scope:Ae(a)}),kt=a({node:[ce({fn:({fn:e,value:t})=>e(t)})],meta:{op:'fx',fx:'sidechain'}});const wt=['source','clock','target'],St=(e,t)=>e+`: ${t} should be defined`;let xt=(e,t,n)=>(r(!X(e)||!X(t),St(n,'either source or clock')),X(e)?(ee(t,n,'clock'),Array.isArray(t)&&(t=w(t)),e=t):_(e)||(e=p(e)),[e,t]);const Ct=(e,t,r,n)=>{let a=e[t];a&&o({target:a,params:Array.isArray(a)?a.map((()=>r)):r,defer:1,stack:n})},Mt="22.1.2";export{A as allSettled,y as attach,lt as clearNode,p as combine,b as createApi,v as createDomain,h as createEffect,u as createEvent,a as createNode,d as createStore,m as createStoreObject,$ as fork,ct as forward,k as fromObservable,C as guard,N as hydrate,W as is,o as launch,w as merge,M as restore,x as sample,F as scopeBind,O as serialize,s as setStoreName,j as split,pe as step,Mt as version,De as withFactory,n as withRegion};
//# sourceMappingURL=effector.mjs.map
