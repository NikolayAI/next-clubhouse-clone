function e(e,t){for(let r in e)t(e[r],r)}function t(e,t){e.forEach(t)}function r(e,t){if(!e)throw Error(t)}function a(e,t){ye={parent:ye,value:e,template:me(e,'template')||be(),sidRoot:me(e,'sidRoot')||ye&&ye.sidRoot};try{return t()}finally{ye=de(ye)}}function n({node:e=[],from:r,source:a,parent:n=r||a,to:o,target:s,child:l=o||s,scope:i={},meta:f={},family:c={type:'regular'},regional:u}={}){let d=xe(n),p=xe(c.links),m=xe(c.owners),g=[];t(e,(e=>e&&F(g,e)));let h={id:W(),seq:g,next:xe(l),meta:f,scope:i,family:{type:c.type||"crosslink",links:p,owners:m}};return t(p,(e=>F(le(e),h))),t(m,(e=>F(ie(e),h))),t(d,(e=>F(e.next,h))),u&&ye&&he(ce(ye),[h]),h}function o(e,r,a){let n=Fe,o=null,s=qe;if(e.target&&(r=e.params,a=e.defer,n='page'in e?e.page:n,e.stack&&(o=e.stack),s=pe(e)||s,e=e.target),s&&qe&&s!==qe&&(qe=null),Array.isArray(e))for(let t=0;t<e.length;t++)Ce('pure',n,se(e[t]),o,r[t],s);else Ce('pure',n,se(e),o,r,s);if(a&&!$e)return;let l,i,f,c,u,d,p={isRoot:$e,currentPage:Fe,scope:qe,isWatch:Oe};$e=0;e:for(;c=je();){let{idx:e,stack:r,type:a}=c;f=r.node,Fe=u=r.page,qe=pe(r),u?d=u.reg:qe&&(d=qe.reg);let n=!!u,o=!!qe,s={fail:0,scope:f.scope};l=i=0;for(let t=e;t<f.seq.length&&!l;t++){let c=f.seq[t];if(c.order){let{priority:n,barrierID:o}=c.order,s=o?u?`${u.fullID}_${o}`:o:0;if(t!==e||a!==n){o?Ne.has(s)||(Ne.add(s),Ae(t,r,n,o)):Ae(t,r,n);continue e}o&&Ne.delete(s)}switch(c.type){case'mov':{let e,t=c.data;switch(t.from){case w:e=ce(r);break;case"a":case'b':e=r[t.from];break;case"value":e=t.store;break;case"store":if(d&&!d[t.store.id])if(n){let e=_e(u,t.store.id);r.page=u=e,e?d=e.reg:o?(Pe(qe,t.store,0,1,t.softRead),d=qe.reg):d=void 0}else o&&Pe(qe,t.store,0,1,t.softRead);e=te(d&&d[t.store.id]||t.store)}switch(t.to){case w:r.value=e;break;case"a":case'b':r[t.to]=e;break;case"store":ze(u,qe,f,t.target).current=e}break}case'compute':let e=c.data;if(e.fn){Oe='watch'===me(f,'op');let t=e.safe?(0,e.fn)(ce(r),s.scope,r):Ee(s,e.fn,r);e.filter?i=!t:r.value=t,Oe=p.isWatch}}l=s.fail||i}if(!l){let e=ce(r);t(f.next,(t=>{Ce('child',u,t,r,e,pe(r))}));let a=pe(r);if(a){me(f,'needFxCounter')&&Ce('child',u,a.fxCount,r,e,a),me(f,'storeChange')&&Ce('child',u,a.storeChange,r,e,a);let n=a.additionalLinks[f.id];n&&t(n,(t=>{Ce('child',u,t,r,e,a)}))}}}$e=p.isRoot,Fe=p.currentPage,qe=pe(p)}function s(t,r="combine"){let a=r+'(',n='',o=0;return e(t,(e=>{o<25&&(null!=e&&(a+=n,a+=S(e)?Ve(e).fullName:e.toString()),o+=1,n=', ')})),a+')'}function l(e,t){let r,a,n=e;if(t){let n=Ve(t);0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)}else r=0===e.length?[]:[e],a=e;return{shortName:n,fullName:a,path:r}}function i(e,t){let r=t?e:e[0];return P(r),r.and&&(e=r.and),[e,r.or]}function f(e,...t){let r=be();if(r){let a=r.handlers[e];if(a)return a(r,...t)}}function c(e,t){let r=(e,...t)=>(D(!me(r,'derived'),'call of derived event','createEvent'),Fe?((e,t,r,a)=>{let n=Fe,o=null;if(t)for(o=Fe;o&&o.template!==t;)o=de(o);Re(o);let s=e.create(r,a);return Re(n),s})(r,a,e,t):r.create(e,t)),a=be();return Object.assign(r,{graphite:n({meta:Qe("event",r,e,t),regional:1}),create:e=>(o({target:r,params:e,scope:qe}),e),watch:e=>Je(r,e),map:e=>Ye(r,k,e,[J({fn:oe})]),filter:e=>Ye(r,"filter",e.fn?e:e.fn,[K({fn:oe})]),filterMap:e=>Ye(r,'filterMap',e,[J({fn:oe}),X((e=>!z(e)),1)]),prepend(e){let t=c('* \u2192 '+r.shortName,{parent:de(r)});return f('eventPrepend',se(t)),Ge(t,r,[J({fn:oe})],'prepend',e),Ke(r,t),t}})}function u(e,a){let s=ee(e),l=Xe('updates');f('storeBase',s);let i=s.id,c={subscribers:new Map,updates:l,defaultState:e,stateRef:s,getState(){let e,t=s;if(Fe){let t=Fe;for(;t&&!t.reg[i];)t=de(t);t&&(e=t)}return!e&&qe&&(Pe(qe,s,1),e=qe),e&&(t=e.reg[i]),te(t)},setState:e=>o({target:c,params:e,defer:1,scope:qe}),reset:(...e)=>(t(e,(e=>c.on(e,(()=>c.defaultState)))),c),on:(e,r)=>(V(e,'.on','first argument'),D(!me(c,'derived'),'.on in derived store','createStore'),t(Array.isArray(e)?e:[e],(e=>{c.off(e),ue(c).set(e,He(Ze(e,c,'on',ne,r)))})),c),off(e){let t=ue(c).get(e);return t&&(t(),ue(c).delete(e)),c},map(e,t){let r,a;R(e)&&(r=e,e=e.fn),D(z(t),'second argument of store.map','updateFilter');let n=c.getState();be()?a=null:z(n)||(a=e(n,t));let o=u(a,{name:`${c.shortName} \u2192 *`,derived:1,and:r}),l=Ze(c,o,k,ae,e);return re(fe(o),{type:k,fn:e,from:s}),fe(o).noInit=1,f('storeMap',s,l),o},watch(e,t){if(!t||!S(e)){let t=Je(c,e);return f('storeWatch',s,e)||e(c.getState()),t}return r(_(t),'second argument should be a function'),e.watch((e=>t(c.getState(),e)))}},d=Qe("store",c,a),p=c.defaultConfig.updateFilter;c.graphite=n({scope:{state:s,fn:p},node:[X(((e,t,r)=>(r.scope&&!r.scope.reg[s.id]&&(r.b=1),e))),Y(s),X(((e,t,{a:r,b:a})=>!z(e)&&(e!==r||a)),1),p&&K({fn:ae}),G({from:w,target:s})],child:l,meta:d,regional:1});let m=me(c,'sid');return m&&('ignore'!==me(c,'serialize')&&ge(c,'storeChange',1),s.sid=m),r(me(c,'derived')||!z(e),"current state can't be undefined, use null instead"),he(c,[l]),c}function d(...e){let t,a,n;[e,n]=i(e);let o,s,l,f=e[e.length-1];if(_(f)?(a=e.slice(0,-1),t=f):a=e,1===a.length){let e=a[0];j(e)||(o=e,s=1)}if(!s&&(o=a,t)){l=1;let e=t;t=t=>e(...t)}return r(R(o),'shape should be an object'),et(Array.isArray(o),!l,o,n,t)}function p(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function m(e,t){let a=c(_(e)?{handler:e}:e,t),s=se(a);ge(s,'op',a.kind="effect"),a.use=e=>(r(_(e),'.use argument should be a function'),g.scope.handler=e,a),a.use.getCurrent=()=>g.scope.handler;let l=a.finally=Xe('finally'),i=a.done=l.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=a.fail=l.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),d=a.doneData=i.map({named:'doneData',fn:({result:e})=>e}),m=a.failData=f.map({named:'failData',fn:({error:e})=>e}),g=n({scope:{handlerId:me(s,'sid'),handler:a.defaultConfig.handler||(()=>r(0,`no handler used in ${a.getType()}`))},node:[X(((e,t,r)=>{let a=t,n=a.handler;if(pe(r)){let e=pe(r).handlers[a.handlerId];e&&(n=e)}return e.handler=n,e}),0,1),X((({params:e,req:t,handler:r,args:a=[e]},n,o)=>{let s=rt(e,t,1,l,o),i=rt(e,t,0,l,o),[f,c]=tt(r,i,a);f&&(R(c)&&_(c.then)?c.then(s,i):s(c))}),0,1)],meta:{op:'fx',fx:'runner'}});s.scope.runner=g,F(s.seq,X(((e,{runner:t},r)=>{let a=de(r)?{params:e,req:{rs(e){},rj(e){}}}:e;return o({target:t,params:a,defer:1,scope:pe(r)}),a.params}),0,1)),a.create=e=>{let t=p(),r={params:e,req:t};if(qe){if(!Oe){let e=qe;t.req.finally((()=>{De(e)})).catch((()=>{}))}o({target:a,params:r,scope:qe})}else o(a,r);return t.req};let h=a.inFlight=u(0,{named:'inFlight'}).on(a,(e=>e+1)).on(l,(e=>e-1));ge(l,'needFxCounter','dec'),ge(a,'needFxCounter',1);let y=a.pending=h.map({fn:e=>e>0,named:'pending'});return he(a,[l,i,f,d,m,y,h]),a}function g(e,t){let r=c(t||s(e,'merge'));return V(e,'merge','first argument'),Ge(e,r,[],'merge'),r}function h(e,a){let n=0;return t(nt,(t=>{t in e&&(r(null!=e[t],ot(a,t)),n=1)})),n}function y(...e){let t,r,a,[[o,s,l],d]=i(e),p=1;z(s)&&R(o)&&h(o,'sample')&&(s=o.clock,l=o.fn,p=!o.greedy,t=o.target,r=o.name,a=o.sid,o=o.source),[o,s]=st(o,s,'sample'),z(s)&&(s=o),V(s,'sample','clock'),d||r||(r=o.shortName);let m=!!t;if(t||(j(o)&&j(s)?t=u(l?l(te(fe(o)),te(fe(s))):te(fe(o)),{name:r,sid:a,or:d}):(t=c(r,d),f('sampleTarget',se(t)))),j(o)){let e=fe(o);he(o,[Ge(s,t,[f('sampleSourceLoader'),Y(e,!l,p),l&&J({fn:ne}),f('sampleSourceUpward',m)],"sample",l)]),f('sampleStoreSource',e)}else{let e=ee(0),r=ee(),a=ee();f('sampleNonStoreSource',e,r,a),n({parent:o,node:[G({from:w,target:r}),G({from:"value",store:1,target:e})],family:{owners:[o,t,s],links:t},meta:{op:"sample"},regional:1}),he(o,[Ge(s,t,[f('sampleSourceLoader'),G({from:w,target:a}),Y(e,1),X((e=>e),1),Y(r,1,p),Y(a),l&&J({fn:ae}),f('sampleSourceUpward',m)],"sample",l)])}return t}function b(e,r){let a=[];(function e(n){$(a,n)||(F(a,n),"store"===me(n,'op')&&me(n,'sid')&&r(n,me(n,'sid')),t(n.next,e),t(le(n),e),t(ie(n),e))})(e)}function v(e,a){if(Array.isArray(e)&&(e=new Map(e)),e instanceof Map){let n={};return t(e,((e,t)=>{r(S(t),'Map key should be a unit'),a&&a(t,e),r(t.sid,'unit should have a sid'),r(!(t.sid in n),'duplicate sid found'),n[t.sid]=e})),n}return e}Object.defineProperty(exports,'__esModule',{value:1});let x='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',k='map',w='stack',S=e=>(_(e)||R(e))&&'kind'in e;const M=e=>t=>S(t)&&t.kind===e;let j=M("store"),C=M("event"),A=M("effect"),I=M("domain"),N=M("scope");var q={__proto__:null,unit:S,store:j,event:C,effect:A,domain:I,scope:N};let $=(e,t)=>e.includes(t),O=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},F=(e,t)=>e.push(t),D=(e,t,r)=>!e&&console.error(`${t} is deprecated, use ${r} instead`),R=e=>'object'==typeof e&&null!==e,_=e=>'function'==typeof e,z=e=>void 0===e,P=e=>r(R(e)||_(e),'expect first argument be an object');const E=(e,t,a,n)=>r(!(!R(e)&&!_(e)||!('family'in e)&&!('graphite'in e)),`${t}: expect ${a} to be a unit (store, event or effect)${n}`);let V=(e,r,a)=>{Array.isArray(e)?t(e,((e,t)=>E(e,r,`${t} item of ${a}`,''))):E(e,r,a,' or array of units')};const B=()=>{let e=0;return()=>""+ ++e};let L=B(),T=B(),W=B();const U=(e,t,r,a)=>{let n={id:T(),type:e,data:t};return r&&(n.order={priority:r},a&&(n.order.barrierID=++H)),n};let H=0,G=({from:e="store",store:t,target:r,to:a=(r?"store":w),batch:n,priority:o})=>U('mov',{from:e,store:t,to:a,target:r},o,n),J=({fn:e,batch:t,priority:r,safe:a=0,filter:n=0})=>U('compute',{fn:e,safe:a,filter:n},r,t),K=({fn:e})=>J({fn:e,filter:1}),Q=({fn:e})=>J({fn:e,priority:"effect"}),X=(e,t,r)=>J({fn:e,safe:1,filter:t,priority:r&&"effect"}),Y=(e,t,r)=>G({store:e,to:t?w:"a",priority:r&&"sampler",batch:1}),Z={mov:G,compute:J,filter:K,run:Q},ee=e=>({id:T(),current:e}),te=({current:e})=>e,re=(e,t)=>{e.before||(e.before=[]),F(e.before,t)},ae=(e,{fn:t},{a:r})=>t(e,r),ne=(e,{fn:t},{a:r})=>t(r,e),oe=(e,{fn:t})=>t(e),se=e=>e.graphite||e,le=e=>e.family.owners,ie=e=>e.family.links,fe=e=>e.stateRef,ce=e=>e.value,ue=e=>e.subscribers,de=e=>e.parent,pe=e=>e.scope,me=(e,t)=>se(e).meta[t],ge=(e,t,r)=>se(e).meta[t]=r,he=(e,r)=>{let a=se(e);t(r,(e=>{let t=se(e);"domain"!==a.family.type&&(t.family.type="crosslink"),F(le(t),a),F(ie(a),t)}))},ye=null,be=()=>ye&&ye.template,ve=e=>(e&&ye&&ye.sidRoot&&(e=`${ye.sidRoot}|${e}`),e);const xe=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(se);let ke=null;const we=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||Ie(e.v.type)>Ie(t.v.type))&&(r=e,e=t,t=r),r=we(e.r,t),e.r=e.l,e.l=r,e},Se=[];let Me=0;for(;Me<6;)F(Se,{first:null,last:null,size:0}),Me+=1;const je=()=>{for(let e=0;e<6;e++){let t=Se[e];if(t.size>0){if(3===e||4===e){t.size-=1;let e=ke.v;return ke=we(ke.l,ke.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Ce=(e,t,r,a,n,o)=>Ae(0,{a:null,b:null,node:r,parent:a,value:n,page:t,scope:o},e),Ae=(e,t,r,a=0)=>{let n=Ie(r),o=Se[n],s={v:{idx:e,stack:t,type:r,id:a},l:null,r:null};3===n||4===n?ke=we(ke,s):(0===o.size?o.first=s:o.last.r=s,o.last=s),o.size+=1},Ie=e=>{switch(e){case'child':return 0;case'pure':return 1;case'read':return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},Ne=new Set;let qe,$e=1,Oe=0,Fe=null,De=e=>{qe=e},Re=e=>{Fe=e};const _e=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=de(e);if(e)return e}return null};let ze=(e,t,r,a,n)=>{let o=_e(e,a.id);return o?o.reg[a.id]:t?(Pe(t,a,n),t.reg[a.id]):a},Pe=(e,r,a,n,o)=>{let s=e.reg,l=r.sid;if(s[r.id])return;let i={id:r.id,current:r.current};if(l&&l in e.sidValuesMap&&!(l in e.sidIdMap))i.current=e.sidValuesMap[l];else if(r.before&&!o){let o=0,l=a||!r.noInit||n;t(r.before,(t=>{switch(t.type){case k:{let r=t.from;if(r||t.fn){r&&Pe(e,r,a,n);let o=r&&s[r.id].current;l&&(i.current=t.fn?t.fn(o):o)}break}case'field':o||(o=1,i.current=Array.isArray(i.current)?[...i.current]:{...i.current}),Pe(e,t.from,a,n),l&&(i.current[t.field]=s[s[t.from.id].id].current)}}))}l&&(e.sidIdMap[l]=r.id),s[r.id]=i};const Ee=(e,t,r)=>{try{return t(ce(r),e.scope,r)}catch(t){console.error(t),e.fail=1}},Ve=e=>e.compositeName;let Be=(t,r={})=>(R(t)&&(Be(t.or,r),e(t,((e,t)=>{z(e)||'or'===t||'and'===t||(r[t]=e)})),Be(t.and,r)),r);const Le=(e,t)=>{O(e.next,t),O(le(e),t),O(ie(e),t)},Te=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=ie(e);for(;a=n.pop();)Le(a,e),(t||r&&'sample'!==me(e,'op')||"crosslink"===a.family.type)&&Te(a,t,'on'!==me(a,'op')&&r);for(n=le(e);a=n.pop();)Le(a,e),r&&"crosslink"===a.family.type&&Te(a,t,'on'!==me(a,'op')&&r)},We=e=>e.clear();let Ue=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),j(e))We(ue(e));else if(I(e)){r=1;let t=e.history;We(t.events),We(t.effects),We(t.stores),We(t.domains)}Te(se(e),!!t,r)},He=e=>{let t=()=>Ue(e);return t.unsubscribe=t,t},Ge=(e,t,r,a,o)=>n({node:r,parent:e,child:t,scope:{fn:o},meta:{op:a},family:{owners:[e,t],links:t},regional:1}),Je=(e,t)=>(r(_(t),'.watch argument should be a function'),He(n({scope:{fn:t},node:[Q({fn:oe})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))),Ke=(e,t,r="event")=>{de(e)&&de(e).hooks[r](t)},Qe=(e,t,r,a)=>{let n="domain"===e,o=L(),s=Be({or:a,and:'string'==typeof r?{name:r}:r}),{parent:i=null,sid:f=null,named:c=null}=s,u=c||s.name||(n?'':o),d=l(u,i),p={op:t.kind=e,name:t.shortName=u,sid:t.sid=ve(f),named:c,unitId:t.id=o,serialize:s.serialize,derived:s.derived};if(t.parent=i,t.compositeName=d,t.defaultConfig=s,t.thru=e=>(D(0,'thru','js pipe'),e(t)),t.getType=()=>d.fullName,!n){t.subscribe=e=>(P(e),t.watch(_(e)?e:t=>e.next&&e.next(t))),t[x]=()=>t;let e=be();e&&(p.nativeTemplate=e)}return p},Xe=e=>c({named:e});const Ye=(e,t,r,a)=>{let n;R(r)&&(n=r,r=r.fn);let o=c({name:`${e.shortName} \u2192 *`,derived:1,and:n});return Ge(e,o,a,t,r),o},Ze=(e,t,r,a,n)=>{let o=fe(t),s=G({store:o,to:"a",priority:'read'});r===k&&(s.data.softRead=1);let l=[s,J({fn:a})];return f('storeOnMap',o,l,j(e)&&fe(e)),Ge(e,t,l,r,n)},et=(t,a,n,o,l)=>{let i=t?e=>e.slice():e=>({...e}),c=t?[]:{},d=i(c),p=ee(d),m=ee(1);p.type=t?'list':'shape',p.noInit=1,f('combineBase',p,m);let g=u(d,{name:s(n),derived:1,and:o}),h=fe(g);h.noInit=1,ge(g,'isCombine',1);let y=[X(((e,t,r)=>(r.scope&&!r.scope.reg[p.id]&&(r.c=1),e))),Y(p),G({store:m,to:'b'}),X(((e,{key:t},r)=>{if(r.c||e!==r.a[t])return a&&r.b&&(r.a=i(r.a)),r.a[t]=e,1}),1),G({from:"a",target:p}),G({from:"value",store:0,target:m}),G({from:"value",store:1,target:m,priority:"barrier",batch:1}),Y(p,1),l&&J({fn:oe})];return e(n,((e,t)=>{if(!j(e))return r(!S(e)&&!z(e),`combine expects a store in a field ${t}`),void(d[t]=c[t]=e);c[t]=e.defaultState,d[t]=e.getState();let a=Ge(e,g,y,'combine',l);a.scope.key=t;let n=fe(e);re(p,{type:'field',field:t,from:n}),f('combineField',n,a)})),g.defaultShape=n,re(h,{type:k,from:p,fn:l}),be()||(g.defaultState=l?h.current=l(d):c),g};let tt=(e,t,r)=>{try{return[1,e(...r)]}catch(e){return t(e),[0,null]}},rt=(e,t,r,a,n)=>s=>o({target:[a,at],params:[r?{status:'done',params:e,result:s}:{status:'fail',params:e,error:s},{value:s,fn:r?t.rs:t.rj}],defer:1,page:n.page,scope:pe(n)}),at=n({node:[Q({fn:({fn:e,value:t})=>e(t)})],meta:{op:'fx',fx:'sidechain'}});const nt=['source','clock','target'],ot=(e,t)=>e+`: ${t} should be defined`;let st=(e,t,a)=>(r(!z(e)||!z(t),ot(a,'either source or clock')),z(e)?(V(t,a,'clock'),Array.isArray(t)&&(t=g(t)),e=t):S(e)||(e=d(e)),[e,t]);const lt=(e,t,r,a)=>{let n=e[t];n&&o({target:n,params:Array.isArray(n)?n.map((()=>r)):r,defer:1,stack:a})};exports.allSettled=(e,{scope:t,params:r})=>{if(!S(e))return Promise.reject(Error('first argument should be unit'));let a=p();a.parentFork=qe;let{fxCount:n}=t;F(n.scope.defers,a);let s=[e],l=[];return F(l,A(e)?{params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}:r),F(s,n),F(l,null),o({target:s,params:l,scope:t}),a.req},exports.attach=e=>{let t;[e,t]=i(e,1);let{source:r,effect:a,mapParams:n}=e,s=m(e,t);ge(s,'attached',1);let l,{runner:f}=se(s).scope,c=X(((e,t,a)=>{let l,{params:i,req:f,handler:c}=e,u=s.finally,d=rt(i,f,0,u,a),p=a.a,m=A(c),g=1;if(n?[g,l]=tt(n,d,[i,p]):l=r&&m?p:i,g){if(!m)return e.args=[p,l],1;o({target:c,params:{params:l,req:{rs:rt(i,f,1,u,a),rj:d}},page:a.page,defer:1})}}),1,1);if(r){let e;j(r)?(e=r,he(e,[s])):(e=d(r),he(s,[e])),l=[Y(fe(e)),c]}else l=[c];return f.seq.splice(1,0,...l),s.use(a),Ke(a,s,"effect"),s},exports.clearNode=Ue,exports.combine=d,exports.createApi=(...t)=>{let[[r,a],n]=i(t),o={};return e(a,((e,t)=>{let a=o[t]=c(t,{parent:de(r),config:n});r.on(a,e),Ke(r,a)})),o},exports.createDomain=function r(a,s){let l=n({family:{type:"domain"},regional:1}),i={history:{},graphite:l,hooks:{}};l.meta=Qe("domain",i,a,s),e({Event:c,Effect:m,Store:u,Domain:r},((e,r)=>{let a=r.toLowerCase(),n=Xe(`on${r}`);i.hooks[a]=n;let s=new Set;i.history[`${a}s`]=s,n.create=e=>(o(n,e),e),F(se(n).seq,X(((e,t,r)=>(r.scope=null,e)))),n.watch((e=>{he(i,[e]),s.add(e),e.ownerSet||(e.ownerSet=s),de(e)||(e.parent=i)})),he(i,[n]),i[`onCreate${r}`]=e=>(t(s,e),n.watch(e)),i[`create${r}`]=i[a]=(t,r)=>n(e(t,{parent:i,or:r}))}));let f=de(i);return f&&e(i.hooks,((e,t)=>Ge(e,f.hooks[t]))),i},exports.createEffect=m,exports.createEvent=c,exports.createNode=n,exports.createStore=u,exports.createStoreObject=(...e)=>(D(0,'createStoreObject','combine'),d(...e)),exports.fork=(e,a)=>{let o,s=e;I(e)&&(o=e,s=a);let l=(e=>{let r=n({scope:{defers:[],inFlight:0,fxID:0},node:[X(((e,t,r)=>{de(r)?'dec'===me(de(r).node,'needFxCounter')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1})),J({priority:"sampler",batch:1}),X(((e,r)=>{let{defers:a,fxID:n}=r;r.inFlight>0||0===a.length||Promise.resolve().then((()=>{r.fxID===n&&t(a.splice(0,a.length),(e=>{De(e.parentFork),e.rs(e.value)}))}))}),0,1)]}),a=n({node:[X(((e,t,r)=>{let a=de(r);if(a&&de(a)){let t=a.node;if(!me(t,'isCombine')||'combine'!==me(de(a).node,'op')){let a=pe(r),n=t.scope.state.id,o=me(t,'sid');a.sidIdMap[o]=n,a.sidValuesMap[o]=e}}}))]}),o={cloneOf:e,reg:{},sidValuesMap:{},sidIdMap:{},getState(e){if('current'in e)return ze(Fe,o,null,e).current;let t=se(e);return ze(Fe,o,t,t.scope.state,1).current},kind:"scope",graphite:n({family:{type:"domain",links:[r,a]},meta:{unit:'fork'},scope:{forkInFlightCounter:r}}),additionalLinks:{},handlers:{},fxCount:r,storeChange:a};return o})(o);if(s){if(s.values){let e=v(s.values,(e=>r(j(e),'Values map can contain only stores as keys')));Object.assign(l.sidValuesMap,e)}s.handlers&&(l.handlers=v(s.handlers,(e=>r(A(e),"Handlers map can contain only effects as keys"))))}return l},exports.forward=e=>{let[{from:t,to:r},a]=i(e,1);return V(t,'forward','"from"'),V(r,'forward','"to"'),He(n({parent:t,child:r,meta:{op:'forward',config:a},family:{},regional:1}))},exports.fromObservable=e=>{P(e);let t=x in e?e[x]():e;r(t.subscribe,'expect observable to have .subscribe');let a=c(),n=He(a);return t.subscribe({next:a,error:n,complete:n}),a},exports.guard=(...e)=>{let t='guard',[[a,o],s]=i(e);o||(o=a,a=o.source),h(o,t);let{filter:l,greedy:f,clock:u,name:d=(s&&s.name?s.name:t)}=o,p=o.target||c(d,s),m=S(l);return[a,u]=st(a,u,t),u&&(V(u,t,'clock'),a=y({source:a,clock:u,greedy:f,fn:m?null:(e,t)=>({source:e,clock:t})})),V(p,t,'target'),m?y({source:l,clock:a,target:n({node:[X((({guard:e})=>e),1),X((({data:e})=>e))],child:p,meta:{op:t},family:{owners:[a,l,p,...[].concat(u||[])],links:p},regional:1}),fn:(e,t)=>({guard:e,data:t}),greedy:f,name:d}):(r(_(l),'`filter` should be function or unit'),Ge(a,p,u?[K({fn:({source:e,clock:t},{fn:r})=>r(e,t)}),X((({source:e})=>e))]:[K({fn:oe})],t,l)),p},exports.hydrate=(e,{values:t})=>{r(R(t),'values property should be an object');let a,n,s,l=v(t),i=Object.getOwnPropertyNames(l),f=[],c=[];N(e)?(a=e,s=1,r(a.cloneOf,'scope should be created from domain'),n=se(a.cloneOf)):I(e)?n=se(e):r(0,'first argument of hydrate should be domain or scope'),b(n,((e,t)=>{$(i,t)&&(F(f,e),F(c,l[t]))})),o({target:f,params:c,scope:a}),s&&Object.assign(a.sidValuesMap,l)},exports.is=q,exports.launch=o,exports.merge=g,exports.restore=(t,r,a)=>{if(j(t))return t;if(C(t)||A(t)){let e=de(t),n=u(r,{parent:e,name:t.shortName,and:a});return Ge(A(t)?t.doneData:t,n),e&&e.hooks.store(n),n}let n=Array.isArray(t)?[]:{};return e(t,((e,t)=>n[t]=j(e)?e:u(e,{name:t}))),n},exports.sample=y,exports.scopeBind=(e,{scope:t}={})=>{r(t||qe,'scopeBind cannot be called outside of forked .watch');let a=t||qe;return A(e)?t=>{let r=p();return o({target:e,params:{params:t,req:r},scope:a}),r.req}:t=>(o({target:e,params:t,scope:a}),t)},exports.serialize=(t,a={})=>{let n=a.ignore?a.ignore.map((({sid:e})=>e)):[],o={};return e(t.sidValuesMap,((e,r)=>{if($(n,r))return;let a=t.sidIdMap[r];o[r]=a&&a in t.reg?t.reg[a].current:e})),'onlyChanges'in a&&!a.onlyChanges&&(r(t.cloneOf,'scope should be created from domain'),b(se(t.cloneOf),((e,r)=>{r in o||$(n,r)||me(e,'isCombine')||'ignore'===me(e,'serialize')||(o[r]=t.getState(e))}))),o},exports.setStoreName=(e,t)=>{e.shortName=t,Object.assign(Ve(e),l(t,de(e)))},exports.split=(...t)=>{let a,[[o,s],l]=i(t),u=!s;u&&(a=o.cases,s=o.match,o=o.source);let d=j(s),p=!S(s)&&_(s),m=!d&&!p&&R(s);a||(a={}),u||(r(m,'match should be an object'),e(s,((e,t)=>a[t]=c(l))),a.__=c(l));let g,h=new Set([].concat(o,Object.values(a))),y=Object.keys(d||p?a:s);if(d||p)d&&h.add(s),g=[d&&Y(fe(s),0,1),J({safe:d,filter:1,fn(e,t,r){let a=String(d?r.a:s(e));lt(t,$(y,a)?a:'__',e,r)}})];else if(m){let t=ee({});t.type='shape';let r,a=[];e(s,((e,n)=>{if(S(e)){r=1,F(a,n),h.add(e);let o=Ge(e,[],[Y(t),X(((e,t,{a:r})=>r[n]=e))]);if(j(e)){t.current[n]=e.getState();let r=fe(e);re(t,{from:r,field:n,type:'field'}),f('splitMatchStore',r,o)}}})),r&&f('splitBase',t),g=[r&&Y(t,0,1),K({fn(e,t,r){for(let n=0;n<y.length;n++){let o=y[n];if($(a,o)?r.a[o]:s[o](e))return void lt(t,o,e,r)}lt(t,'__',e,r)}})]}else r(0,'expect match to be unit, function or object');if(n({meta:{op:'split'},parent:o,scope:a,node:g,family:{owners:Array.from(h)},regional:1}),!u)return a},exports.step=Z,exports.version="22.1.2",exports.withFactory=({sid:e,name:t,loc:r,method:o,fn:s})=>a(n({meta:{sidRoot:ve(e),name:t,loc:r,method:o}}),s),exports.withRegion=a;
//# sourceMappingURL=effector.cjs.js.map
