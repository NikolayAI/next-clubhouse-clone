((e,t)=>{'object'==typeof exports&&'undefined'!=typeof module?t(exports):'function'==typeof define&&define.amd?define(['exports'],t):t((e='undefined'!=typeof globalThis?globalThis:e||self).effector={})})(this,(e=>{function t(e,t){for(let r in e)t(e[r],r)}function r(e,t){e.forEach(t)}function a(e,t){if(!e)throw Error(t)}function n(e,t){Ne={parent:Ne,value:e,template:Ce(e,'template')||qe(),sidRoot:Ce(e,'sidRoot')||Ne&&Ne.sidRoot};try{return t()}finally{Ne=je(Ne)}}function o({node:e=[],from:t,source:a,parent:n=t||a,to:o,target:l,child:s=o||l,scope:i={},meta:f={},family:c={type:'regular'},regional:d}={}){let u=Oe(n),p=Oe(c.links),m=Oe(c.owners),g=[];r(e,(e=>e&&U(g,e)));let h={id:re(),seq:g,next:Oe(s),meta:f,scope:i,family:{type:c.type||I,links:p,owners:m}};return r(p,(e=>U(ve(e),h))),r(m,(e=>U(ke(e),h))),r(u,(e=>U(e.next,h))),d&&Ne&&Ie(Se(Ne),[h]),h}function l(e,t,a){let n=Ue,o=null,l=Be;if(e.target&&(t=e.params,a=e.defer,n='page'in e?e.page:n,e.stack&&(o=e.stack),l=Me(e)||l,e=e.target),l&&Be&&l!==Be&&(Be=null),Array.isArray(e))for(let r=0;r<e.length;r++)Pe('pure',n,be(e[r]),o,t[r],l);else Pe('pure',n,be(e),o,t,l);if(a&&!Le)return;let s,i,f,c,d,u,p={isRoot:Le,currentPage:Ue,scope:Be,isWatch:We};Le=0;e:for(;c=ze();){let{idx:e,stack:t,type:a}=c;f=t.node,Ue=d=t.page,Be=Me(t),d?u=d.reg:Be&&(u=Be.reg);let n=!!d,o=!!Be,l={fail:0,scope:f.scope};s=i=0;for(let r=e;r<f.seq.length&&!s;r++){let c=f.seq[r];if(c.order){let{priority:n,barrierID:o}=c.order,l=o?d?`${d.fullID}_${o}`:o:0;if(r!==e||a!==n){o?Te.has(l)||(Te.add(l),Ee(r,t,n,o)):Ee(r,t,n);continue e}o&&Te.delete(l)}switch(c.type){case'mov':{let e,r=c.data;switch(r.from){case q:e=Se(t);break;case D:case'b':e=t[r.from];break;case O:e=r.store;break;case S:if(u&&!u[r.store.id])if(n){let e=Je(d,r.store.id);t.page=d=e,e?u=e.reg:o?(Qe(Be,r.store,0,1,r.softRead),u=Be.reg):u=void 0}else o&&Qe(Be,r.store,0,1,r.softRead);e=pe(u&&u[r.store.id]||r.store)}switch(r.to){case q:t.value=e;break;case D:case'b':t[r.to]=e;break;case S:Ke(d,Be,f,r.target).current=e}break}case'compute':let e=c.data;if(e.fn){We='watch'===Ce(f,'op');let r=e.safe?(0,e.fn)(Se(t),l.scope,t):Xe(l,e.fn,t);e.filter?i=!r:t.value=r,We=p.isWatch}}s=l.fail||i}if(!s){let e=Se(t);r(f.next,(r=>{Pe('child',d,r,t,e,Me(t))}));let a=Me(t);if(a){Ce(f,'needFxCounter')&&Pe('child',d,a.fxCount,t,e,a),Ce(f,'storeChange')&&Pe('child',d,a.storeChange,t,e,a);let n=a.additionalLinks[f.id];n&&r(n,(r=>{Pe('child',d,r,t,e,a)}))}}}Le=p.isRoot,Ue=p.currentPage,Be=Me(p)}function s(e,r="combine"){let a=r+'(',n='',o=0;return t(e,(e=>{o<25&&(null!=e&&(a+=n,a+=R(e)?Ye(e).fullName:e.toString()),o+=1,n=', ')})),a+')'}function i(e,t){let r,a,n=e;if(t){let n=Ye(t);0===e.length?(r=n.path,a=n.fullName):(r=n.path.concat([e]),a=0===n.fullName.length?e:n.fullName+'/'+e)}else r=0===e.length?[]:[e],a=e;return{shortName:n,fullName:a,path:r}}function f(e,t){let r=t?e:e[0];return Q(r),r.and&&(e=r.and),[e,r.or]}function c(e,...t){let r=qe();if(r){let a=r.handlers[e];if(a)return a(r,...t)}}function d(e,t){let r=(e,...t)=>(H(!Ce(r,'derived'),'call of derived event','createEvent'),Ue?((e,t,r,a)=>{let n=Ue,o=null;if(t)for(o=Ue;o&&o.template!==t;)o=je(o);Ge(o);let l=e.create(r,a);return Ge(n),l})(r,a,e,t):r.create(e,t)),a=qe();return Object.assign(r,{graphite:o({meta:ft(x,r,e,t),regional:1}),create:e=>(l({target:r,params:e,scope:Be}),e),watch:e=>lt(r,e),map:e=>dt(r,N,e,[le({fn:ye})]),filter:e=>dt(r,"filter",e.fn?e:e.fn,[se({fn:ye})]),filterMap:e=>dt(r,'filterMap',e,[le({fn:ye}),fe((e=>!K(e)),1)]),prepend(e){let t=d('* \u2192 '+r.shortName,{parent:je(r)});return c('eventPrepend',be(t)),ot(t,r,[le({fn:ye})],'prepend',e),st(r,t),t}})}function u(e,t){let n=ue(e),s=ct('updates');c('storeBase',n);let i=n.id,f={subscribers:new Map,updates:s,defaultState:e,stateRef:n,getState(){let e,t=n;if(Ue){let t=Ue;for(;t&&!t.reg[i];)t=je(t);t&&(e=t)}return!e&&Be&&(Qe(Be,n,1),e=Be),e&&(t=e.reg[i]),pe(t)},setState:e=>l({target:f,params:e,defer:1,scope:Be}),reset:(...e)=>(r(e,(e=>f.on(e,(()=>f.defaultState)))),f),on:(e,t)=>(Y(e,'.on','first argument'),H(!Ce(f,'derived'),'.on in derived store','createStore'),r(Array.isArray(e)?e:[e],(e=>{f.off(e),xe(f).set(e,nt(ut(e,f,'on',he,t)))})),f),off(e){let t=xe(f).get(e);return t&&(t(),xe(f).delete(e)),f},map(e,t){let r,a;G(e)&&(r=e,e=e.fn),H(K(t),'second argument of store.map','updateFilter');let o=f.getState();qe()?a=null:K(o)||(a=e(o,t));let l=u(a,{name:`${f.shortName} \u2192 *`,derived:1,and:r}),s=ut(f,l,N,ge,e);return me(we(l),{type:N,fn:e,from:n}),we(l).noInit=1,c('storeMap',n,s),l},watch(e,t){if(!t||!R(e)){let t=lt(f,e);return c('storeWatch',n,e)||e(f.getState()),t}return a(J(t),'second argument should be a function'),e.watch((e=>t(f.getState(),e)))}},d=ft(S,f,t),p=f.defaultConfig.updateFilter;f.graphite=o({scope:{state:n,fn:p},node:[fe(((e,t,r)=>(r.scope&&!r.scope.reg[n.id]&&(r.b=1),e))),ce(n),fe(((e,t,{a:r,b:a})=>!K(e)&&(e!==r||a)),1),p&&se({fn:ge}),oe({from:q,target:n})],child:s,meta:d,regional:1});let m=Ce(f,'sid');return m&&('ignore'!==Ce(f,'serialize')&&Ae(f,'storeChange',1),n.sid=m),a(Ce(f,'derived')||!K(e),"current state can't be undefined, use null instead"),Ie(f,[s]),f}function p(...e){let t,r,n;[e,n]=f(e);let o,l,s,i=e[e.length-1];if(J(i)?(r=e.slice(0,-1),t=i):r=e,1===r.length){let e=r[0];z(e)||(o=e,l=1)}if(!l&&(o=r,t)){s=1;let e=t;t=t=>e(...t)}return a(G(o),'shape should be an object'),pt(Array.isArray(o),!s,o,n,t)}function m(){let e={};return e.req=new Promise(((t,r)=>{e.rs=t,e.rj=r})),e.req.catch((()=>{})),e}function g(e,t){let r=d(J(e)?{handler:e}:e,t),n=be(r);Ae(n,'op',r.kind=j),r.use=e=>(a(J(e),'.use argument should be a function'),g.scope.handler=e,r),r.use.getCurrent=()=>g.scope.handler;let s=r.finally=ct('finally'),i=r.done=s.filterMap({named:'done',fn({status:e,params:t,result:r}){if('done'===e)return{params:t,result:r}}}),f=r.fail=s.filterMap({named:'fail',fn({status:e,params:t,error:r}){if('fail'===e)return{params:t,error:r}}}),c=r.doneData=i.map({named:'doneData',fn:({result:e})=>e}),p=r.failData=f.map({named:'failData',fn:({error:e})=>e}),g=o({scope:{handlerId:Ce(n,'sid'),handler:r.defaultConfig.handler||(()=>a(0,`no handler used in ${r.getType()}`))},node:[fe(((e,t,r)=>{let a=t,n=a.handler;if(Me(r)){let e=Me(r).handlers[a.handlerId];e&&(n=e)}return e.handler=n,e}),0,1),fe((({params:e,req:t,handler:r,args:a=[e]},n,o)=>{let l=gt(e,t,1,s,o),i=gt(e,t,0,s,o),[f,c]=mt(r,i,a);f&&(G(c)&&J(c.then)?c.then(l,i):l(c))}),0,1)],meta:{op:'fx',fx:'runner'}});n.scope.runner=g,U(n.seq,fe(((e,{runner:t},r)=>{let a=je(r)?{params:e,req:{rs(e){},rj(e){}}}:e;return l({target:t,params:a,defer:1,scope:Me(r)}),a.params}),0,1)),r.create=e=>{let t=m(),a={params:e,req:t};if(Be){if(!We){let e=Be;t.req.finally((()=>{He(e)})).catch((()=>{}))}l({target:r,params:a,scope:Be})}else l(r,a);return t.req};let h=r.inFlight=u(0,{named:'inFlight'}).on(r,(e=>e+1)).on(s,(e=>e-1));Ae(s,'needFxCounter','dec'),Ae(r,'needFxCounter',1);let y=r.pending=h.map({fn:e=>e>0,named:'pending'});return Ie(r,[s,i,f,c,p,y,h]),r}function h(e,t){let r=d(t||s(e,'merge'));return Y(e,'merge','first argument'),ot(e,r,[],'merge'),r}function y(e,t){let n=0;return r(yt,(r=>{r in e&&(a(null!=e[r],bt(t,r)),n=1)})),n}function b(...e){let t,r,a,[[n,l,s],i]=f(e),p=1;K(l)&&G(n)&&y(n,'sample')&&(l=n.clock,s=n.fn,p=!n.greedy,t=n.target,r=n.name,a=n.sid,n=n.source),[n,l]=vt(n,l,'sample'),K(l)&&(l=n),Y(l,'sample','clock'),i||r||(r=n.shortName);let m=!!t;if(t||(z(n)&&z(l)?t=u(s?s(pe(we(n)),pe(we(l))):pe(we(n)),{name:r,sid:a,or:i}):(t=d(r,i),c('sampleTarget',be(t)))),z(n)){let e=we(n);Ie(n,[ot(l,t,[c('sampleSourceLoader'),ce(e,!s,p),s&&le({fn:he}),c('sampleSourceUpward',m)],F,s)]),c('sampleStoreSource',e)}else{let e=ue(0),r=ue(),a=ue();c('sampleNonStoreSource',e,r,a),o({parent:n,node:[oe({from:q,target:r}),oe({from:O,store:1,target:e})],family:{owners:[n,t,l],links:t},meta:{op:F},regional:1}),Ie(n,[ot(l,t,[c('sampleSourceLoader'),oe({from:q,target:a}),ce(e,1),fe((e=>e),1),ce(r,1,p),ce(a),s&&le({fn:ge}),c('sampleSourceUpward',m)],F,s)])}return t}function v(e,t){let a=[];(function e(n){L(a,n)||(U(a,n),Ce(n,'op')===S&&Ce(n,'sid')&&t(n,Ce(n,'sid')),r(n.next,e),r(ve(n),e),r(ke(n),e))})(e)}function k(e,t){if(Array.isArray(e)&&(e=new Map(e)),e instanceof Map){let n={};return r(e,((e,r)=>{a(R(r),'Map key should be a unit'),t&&t(r,e),a(r.sid,'unit should have a sid'),a(!(r.sid in n),'duplicate sid found'),n[r.sid]=e})),n}return e}let w='undefined'!=typeof Symbol&&Symbol.observable||'@@observable',S='store',x='event',j='effect',M='domain',C='scope',A='sampler',I='crosslink',N='map',q='stack',$='barrier',O='value',F='sample',D='a',R=e=>(J(e)||G(e))&&'kind'in e;const _=e=>t=>R(t)&&t.kind===e;let z=_(S),P=_(x),E=_(j),V=_(M),T=_(C);var B={__proto__:null,unit:R,store:z,event:P,effect:E,domain:V,scope:T};let L=(e,t)=>e.includes(t),W=(e,t)=>{let r=e.indexOf(t);-1!==r&&e.splice(r,1)},U=(e,t)=>e.push(t),H=(e,t,r)=>!e&&console.error(`${t} is deprecated, use ${r} instead`),G=e=>'object'==typeof e&&null!==e,J=e=>'function'==typeof e,K=e=>void 0===e,Q=e=>a(G(e)||J(e),'expect first argument be an object');const X=(e,t,r,n)=>a(!(!G(e)&&!J(e)||!('family'in e)&&!('graphite'in e)),`${t}: expect ${r} to be a unit (store, event or effect)${n}`);let Y=(e,t,a)=>{Array.isArray(e)?r(e,((e,r)=>X(e,t,`${r} item of ${a}`,''))):X(e,t,a,' or array of units')};const Z=()=>{let e=0;return()=>""+ ++e};let ee=Z(),te=Z(),re=Z();const ae=(e,t,r,a)=>{let n={id:te(),type:e,data:t};return r&&(n.order={priority:r},a&&(n.order.barrierID=++ne)),n};let ne=0,oe=({from:e=S,store:t,target:r,to:a=(r?S:q),batch:n,priority:o})=>ae('mov',{from:e,store:t,to:a,target:r},o,n),le=({fn:e,batch:t,priority:r,safe:a=0,filter:n=0})=>ae('compute',{fn:e,safe:a,filter:n},r,t),se=({fn:e})=>le({fn:e,filter:1}),ie=({fn:e})=>le({fn:e,priority:j}),fe=(e,t,r)=>le({fn:e,safe:1,filter:t,priority:r&&j}),ce=(e,t,r)=>oe({store:e,to:t?q:D,priority:r&&A,batch:1}),de={mov:oe,compute:le,filter:se,run:ie},ue=e=>({id:te(),current:e}),pe=({current:e})=>e,me=(e,t)=>{e.before||(e.before=[]),U(e.before,t)},ge=(e,{fn:t},{a:r})=>t(e,r),he=(e,{fn:t},{a:r})=>t(r,e),ye=(e,{fn:t})=>t(e),be=e=>e.graphite||e,ve=e=>e.family.owners,ke=e=>e.family.links,we=e=>e.stateRef,Se=e=>e.value,xe=e=>e.subscribers,je=e=>e.parent,Me=e=>e.scope,Ce=(e,t)=>be(e).meta[t],Ae=(e,t,r)=>be(e).meta[t]=r,Ie=(e,t)=>{let a=be(e);r(t,(e=>{let t=be(e);a.family.type!==M&&(t.family.type=I),U(ve(t),a),U(ke(a),t)}))},Ne=null,qe=()=>Ne&&Ne.template,$e=e=>(e&&Ne&&Ne.sidRoot&&(e=`${Ne.sidRoot}|${e}`),e);const Oe=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(be);let Fe=null;const De=(e,t)=>{if(!e)return t;if(!t)return e;let r;return(e.v.type===t.v.type&&e.v.id>t.v.id||Ve(e.v.type)>Ve(t.v.type))&&(r=e,e=t,t=r),r=De(e.r,t),e.r=e.l,e.l=r,e},Re=[];let _e=0;for(;_e<6;)U(Re,{first:null,last:null,size:0}),_e+=1;const ze=()=>{for(let e=0;e<6;e++){let t=Re[e];if(t.size>0){if(3===e||4===e){t.size-=1;let e=Fe.v;return Fe=De(Fe.l,Fe.r),e}1===t.size&&(t.last=null);let r=t.first;return t.first=r.r,t.size-=1,r.v}}},Pe=(e,t,r,a,n,o)=>Ee(0,{a:null,b:null,node:r,parent:a,value:n,page:t,scope:o},e),Ee=(e,t,r,a=0)=>{let n=Ve(r),o=Re[n],l={v:{idx:e,stack:t,type:r,id:a},l:null,r:null};3===n||4===n?Fe=De(Fe,l):(0===o.size?o.first=l:o.last.r=l,o.last=l),o.size+=1},Ve=e=>{switch(e){case'child':return 0;case'pure':return 1;case'read':return 2;case $:return 3;case A:return 4;case j:return 5;default:return-1}},Te=new Set;let Be,Le=1,We=0,Ue=null,He=e=>{Be=e},Ge=e=>{Ue=e};const Je=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=je(e);if(e)return e}return null};let Ke=(e,t,r,a,n)=>{let o=Je(e,a.id);return o?o.reg[a.id]:t?(Qe(t,a,n),t.reg[a.id]):a},Qe=(e,t,a,n,o)=>{let l=e.reg,s=t.sid;if(l[t.id])return;let i={id:t.id,current:t.current};if(s&&s in e.sidValuesMap&&!(s in e.sidIdMap))i.current=e.sidValuesMap[s];else if(t.before&&!o){let o=0,s=a||!t.noInit||n;r(t.before,(t=>{switch(t.type){case N:{let r=t.from;if(r||t.fn){r&&Qe(e,r,a,n);let o=r&&l[r.id].current;s&&(i.current=t.fn?t.fn(o):o)}break}case'field':o||(o=1,i.current=Array.isArray(i.current)?[...i.current]:{...i.current}),Qe(e,t.from,a,n),s&&(i.current[t.field]=l[l[t.from.id].id].current)}}))}s&&(e.sidIdMap[s]=t.id),l[t.id]=i};const Xe=(e,t,r)=>{try{return t(Se(r),e.scope,r)}catch(t){console.error(t),e.fail=1}},Ye=e=>e.compositeName;let Ze=(e,r={})=>(G(e)&&(Ze(e.or,r),t(e,((e,t)=>{K(e)||'or'===t||'and'===t||(r[t]=e)})),Ze(e.and,r)),r);const et=(e,t)=>{W(e.next,t),W(ve(e),t),W(ke(e),t)},tt=(e,t,r)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let n=ke(e);for(;a=n.pop();)et(a,e),(t||r&&'sample'!==Ce(e,'op')||a.family.type===I)&&tt(a,t,'on'!==Ce(a,'op')&&r);for(n=ve(e);a=n.pop();)et(a,e),r&&a.family.type===I&&tt(a,t,'on'!==Ce(a,'op')&&r)},rt=e=>e.clear();let at=(e,{deep:t}={})=>{let r=0;if(e.ownerSet&&e.ownerSet.delete(e),z(e))rt(xe(e));else if(V(e)){r=1;let t=e.history;rt(t.events),rt(t.effects),rt(t.stores),rt(t.domains)}tt(be(e),!!t,r)},nt=e=>{let t=()=>at(e);return t.unsubscribe=t,t},ot=(e,t,r,a,n)=>o({node:r,parent:e,child:t,scope:{fn:n},meta:{op:a},family:{owners:[e,t],links:t},regional:1}),lt=(e,t)=>(a(J(t),'.watch argument should be a function'),nt(o({scope:{fn:t},node:[ie({fn:ye})],parent:e,meta:{op:'watch'},family:{owners:e},regional:1}))),st=(e,t,r=x)=>{je(e)&&je(e).hooks[r](t)},ft=(e,t,r,a)=>{let n=e===M,o=ee(),l=Ze({or:a,and:'string'==typeof r?{name:r}:r}),{parent:s=null,sid:f=null,named:c=null}=l,d=c||l.name||(n?'':o),u=i(d,s),p={op:t.kind=e,name:t.shortName=d,sid:t.sid=$e(f),named:c,unitId:t.id=o,serialize:l.serialize,derived:l.derived};if(t.parent=s,t.compositeName=u,t.defaultConfig=l,t.thru=e=>(H(0,'thru','js pipe'),e(t)),t.getType=()=>u.fullName,!n){t.subscribe=e=>(Q(e),t.watch(J(e)?e:t=>e.next&&e.next(t))),t[w]=()=>t;let e=qe();e&&(p.nativeTemplate=e)}return p},ct=e=>d({named:e});const dt=(e,t,r,a)=>{let n;G(r)&&(n=r,r=r.fn);let o=d({name:`${e.shortName} \u2192 *`,derived:1,and:n});return ot(e,o,a,t,r),o},ut=(e,t,r,a,n)=>{let o=we(t),l=oe({store:o,to:D,priority:'read'});r===N&&(l.data.softRead=1);let s=[l,le({fn:a})];return c('storeOnMap',o,s,z(e)&&we(e)),ot(e,t,s,r,n)},pt=(e,r,n,o,l)=>{let i=e?e=>e.slice():e=>({...e}),f=e?[]:{},d=i(f),p=ue(d),m=ue(1);p.type=e?'list':'shape',p.noInit=1,c('combineBase',p,m);let g=u(d,{name:s(n),derived:1,and:o}),h=we(g);h.noInit=1,Ae(g,'isCombine',1);let y=[fe(((e,t,r)=>(r.scope&&!r.scope.reg[p.id]&&(r.c=1),e))),ce(p),oe({store:m,to:'b'}),fe(((e,{key:t},a)=>{if(a.c||e!==a.a[t])return r&&a.b&&(a.a=i(a.a)),a.a[t]=e,1}),1),oe({from:D,target:p}),oe({from:O,store:0,target:m}),oe({from:O,store:1,target:m,priority:$,batch:1}),ce(p,1),l&&le({fn:ye})];return t(n,((e,t)=>{if(!z(e))return a(!R(e)&&!K(e),`combine expects a store in a field ${t}`),void(d[t]=f[t]=e);f[t]=e.defaultState,d[t]=e.getState();let r=ot(e,g,y,'combine',l);r.scope.key=t;let n=we(e);me(p,{type:'field',field:t,from:n}),c('combineField',n,r)})),g.defaultShape=n,me(h,{type:N,from:p,fn:l}),qe()||(g.defaultState=l?h.current=l(d):f),g};let mt=(e,t,r)=>{try{return[1,e(...r)]}catch(e){return t(e),[0,null]}},gt=(e,t,r,a,n)=>o=>l({target:[a,ht],params:[r?{status:'done',params:e,result:o}:{status:'fail',params:e,error:o},{value:o,fn:r?t.rs:t.rj}],defer:1,page:n.page,scope:Me(n)}),ht=o({node:[ie({fn:({fn:e,value:t})=>e(t)})],meta:{op:'fx',fx:'sidechain'}});const yt=['source','clock','target'],bt=(e,t)=>e+`: ${t} should be defined`;let vt=(e,t,r)=>(a(!K(e)||!K(t),bt(r,'either source or clock')),K(e)?(Y(t,r,'clock'),Array.isArray(t)&&(t=h(t)),e=t):R(e)||(e=p(e)),[e,t]);const kt=(e,t,r,a)=>{let n=e[t];n&&l({target:n,params:Array.isArray(n)?n.map((()=>r)):r,defer:1,stack:a})};e.allSettled=(e,{scope:t,params:r})=>{if(!R(e))return Promise.reject(Error('first argument should be unit'));let a=m();a.parentFork=Be;let{fxCount:n}=t;U(n.scope.defers,a);let o=[e],s=[];return U(s,E(e)?{params:r,req:{rs(e){a.value={status:'done',value:e}},rj(e){a.value={status:'fail',value:e}}}}:r),U(o,n),U(s,null),l({target:o,params:s,scope:t}),a.req},e.attach=e=>{let t;[e,t]=f(e,1);let{source:r,effect:a,mapParams:n}=e,o=g(e,t);Ae(o,'attached',1);let s,{runner:i}=be(o).scope,c=fe(((e,t,a)=>{let s,{params:i,req:f,handler:c}=e,d=o.finally,u=gt(i,f,0,d,a),p=a.a,m=E(c),g=1;if(n?[g,s]=mt(n,u,[i,p]):s=r&&m?p:i,g){if(!m)return e.args=[p,s],1;l({target:c,params:{params:s,req:{rs:gt(i,f,1,d,a),rj:u}},page:a.page,defer:1})}}),1,1);if(r){let e;z(r)?(e=r,Ie(e,[o])):(e=p(r),Ie(o,[e])),s=[ce(we(e)),c]}else s=[c];return i.seq.splice(1,0,...s),o.use(a),st(a,o,j),o},e.clearNode=at,e.combine=p,e.createApi=(...e)=>{let[[r,a],n]=f(e),o={};return t(a,((e,t)=>{let a=o[t]=d(t,{parent:je(r),config:n});r.on(a,e),st(r,a)})),o},e.createDomain=function e(a,n){let s=o({family:{type:M},regional:1}),i={history:{},graphite:s,hooks:{}};s.meta=ft(M,i,a,n),t({Event:d,Effect:g,Store:u,Domain:e},((e,t)=>{let a=t.toLowerCase(),n=ct(`on${t}`);i.hooks[a]=n;let o=new Set;i.history[`${a}s`]=o,n.create=e=>(l(n,e),e),U(be(n).seq,fe(((e,t,r)=>(r.scope=null,e)))),n.watch((e=>{Ie(i,[e]),o.add(e),e.ownerSet||(e.ownerSet=o),je(e)||(e.parent=i)})),Ie(i,[n]),i[`onCreate${t}`]=e=>(r(o,e),n.watch(e)),i[`create${t}`]=i[a]=(t,r)=>n(e(t,{parent:i,or:r}))}));let f=je(i);return f&&t(i.hooks,((e,t)=>ot(e,f.hooks[t]))),i},e.createEffect=g,e.createEvent=d,e.createNode=o,e.createStore=u,e.createStoreObject=(...e)=>(H(0,'createStoreObject','combine'),p(...e)),e.fork=(e,t)=>{let n,l=e;V(e)&&(n=e,l=t);let s=(e=>{let t=o({scope:{defers:[],inFlight:0,fxID:0},node:[fe(((e,t,r)=>{je(r)?'dec'===Ce(je(r).node,'needFxCounter')?t.inFlight-=1:(t.inFlight+=1,t.fxID+=1):t.fxID+=1})),le({priority:A,batch:1}),fe(((e,t)=>{let{defers:a,fxID:n}=t;t.inFlight>0||0===a.length||Promise.resolve().then((()=>{t.fxID===n&&r(a.splice(0,a.length),(e=>{He(e.parentFork),e.rs(e.value)}))}))}),0,1)]}),a=o({node:[fe(((e,t,r)=>{let a=je(r);if(a&&je(a)){let t=a.node;if(!Ce(t,'isCombine')||'combine'!==Ce(je(a).node,'op')){let a=Me(r),n=t.scope.state.id,o=Ce(t,'sid');a.sidIdMap[o]=n,a.sidValuesMap[o]=e}}}))]}),n={cloneOf:e,reg:{},sidValuesMap:{},sidIdMap:{},getState(e){if('current'in e)return Ke(Ue,n,null,e).current;let t=be(e);return Ke(Ue,n,t,t.scope.state,1).current},kind:C,graphite:o({family:{type:M,links:[t,a]},meta:{unit:'fork'},scope:{forkInFlightCounter:t}}),additionalLinks:{},handlers:{},fxCount:t,storeChange:a};return n})(n);if(l){if(l.values){let e=k(l.values,(e=>a(z(e),'Values map can contain only stores as keys')));Object.assign(s.sidValuesMap,e)}l.handlers&&(s.handlers=k(l.handlers,(e=>a(E(e),"Handlers map can contain only effects as keys"))))}return s},e.forward=e=>{let[{from:t,to:r},a]=f(e,1);return Y(t,'forward','"from"'),Y(r,'forward','"to"'),nt(o({parent:t,child:r,meta:{op:'forward',config:a},family:{},regional:1}))},e.fromObservable=e=>{Q(e);let t=w in e?e[w]():e;a(t.subscribe,'expect observable to have .subscribe');let r=d(),n=nt(r);return t.subscribe({next:r,error:n,complete:n}),r},e.guard=(...e)=>{let t='guard',[[r,n],l]=f(e);n||(n=r,r=n.source),y(n,t);let{filter:s,greedy:i,clock:c,name:u=(l&&l.name?l.name:t)}=n,p=n.target||d(u,l),m=R(s);return[r,c]=vt(r,c,t),c&&(Y(c,t,'clock'),r=b({source:r,clock:c,greedy:i,fn:m?null:(e,t)=>({source:e,clock:t})})),Y(p,t,'target'),m?b({source:s,clock:r,target:o({node:[fe((({guard:e})=>e),1),fe((({data:e})=>e))],child:p,meta:{op:t},family:{owners:[r,s,p,...[].concat(c||[])],links:p},regional:1}),fn:(e,t)=>({guard:e,data:t}),greedy:i,name:u}):(a(J(s),'`filter` should be function or unit'),ot(r,p,c?[se({fn:({source:e,clock:t},{fn:r})=>r(e,t)}),fe((({source:e})=>e))]:[se({fn:ye})],t,s)),p},e.hydrate=(e,{values:t})=>{a(G(t),'values property should be an object');let r,n,o,s=k(t),i=Object.getOwnPropertyNames(s),f=[],c=[];T(e)?(r=e,o=1,a(r.cloneOf,'scope should be created from domain'),n=be(r.cloneOf)):V(e)?n=be(e):a(0,'first argument of hydrate should be domain or scope'),v(n,((e,t)=>{L(i,t)&&(U(f,e),U(c,s[t]))})),l({target:f,params:c,scope:r}),o&&Object.assign(r.sidValuesMap,s)},e.is=B,e.launch=l,e.merge=h,e.restore=(e,r,a)=>{if(z(e))return e;if(P(e)||E(e)){let t=je(e),n=u(r,{parent:t,name:e.shortName,and:a});return ot(E(e)?e.doneData:e,n),t&&t.hooks.store(n),n}let n=Array.isArray(e)?[]:{};return t(e,((e,t)=>n[t]=z(e)?e:u(e,{name:t}))),n},e.sample=b,e.scopeBind=(e,{scope:t}={})=>{a(t||Be,'scopeBind cannot be called outside of forked .watch');let r=t||Be;return E(e)?t=>{let a=m();return l({target:e,params:{params:t,req:a},scope:r}),a.req}:t=>(l({target:e,params:t,scope:r}),t)},e.serialize=(e,r={})=>{let n=r.ignore?r.ignore.map((({sid:e})=>e)):[],o={};return t(e.sidValuesMap,((t,r)=>{if(L(n,r))return;let a=e.sidIdMap[r];o[r]=a&&a in e.reg?e.reg[a].current:t})),'onlyChanges'in r&&!r.onlyChanges&&(a(e.cloneOf,'scope should be created from domain'),v(be(e.cloneOf),((t,r)=>{r in o||L(n,r)||Ce(t,'isCombine')||'ignore'===Ce(t,'serialize')||(o[r]=e.getState(t))}))),o},e.setStoreName=(e,t)=>{e.shortName=t,Object.assign(Ye(e),i(t,je(e)))},e.split=(...e)=>{let r,[[n,l],s]=f(e),i=!l;i&&(r=n.cases,l=n.match,n=n.source);let u=z(l),p=!R(l)&&J(l),m=!u&&!p&&G(l);r||(r={}),i||(a(m,'match should be an object'),t(l,((e,t)=>r[t]=d(s))),r.__=d(s));let g,h=new Set([].concat(n,Object.values(r))),y=Object.keys(u||p?r:l);if(u||p)u&&h.add(l),g=[u&&ce(we(l),0,1),le({safe:u,filter:1,fn(e,t,r){let a=String(u?r.a:l(e));kt(t,L(y,a)?a:'__',e,r)}})];else if(m){let e=ue({});e.type='shape';let r,a=[];t(l,((t,n)=>{if(R(t)){r=1,U(a,n),h.add(t);let o=ot(t,[],[ce(e),fe(((e,t,{a:r})=>r[n]=e))]);if(z(t)){e.current[n]=t.getState();let r=we(t);me(e,{from:r,field:n,type:'field'}),c('splitMatchStore',r,o)}}})),r&&c('splitBase',e),g=[r&&ce(e,0,1),se({fn(e,t,r){for(let n=0;n<y.length;n++){let o=y[n];if(L(a,o)?r.a[o]:l[o](e))return void kt(t,o,e,r)}kt(t,'__',e,r)}})]}else a(0,'expect match to be unit, function or object');if(o({meta:{op:'split'},parent:n,scope:r,node:g,family:{owners:Array.from(h)},regional:1}),!i)return r},e.step=de,e.version="22.1.2",e.withFactory=({sid:e,name:t,loc:r,method:a,fn:l})=>n(o({meta:{sidRoot:$e(e),name:t,loc:r,method:a}}),l),e.withRegion=n,Object.defineProperty(e,'__esModule',{value:1})}));
//# sourceMappingURL=effector.umd.js.map
